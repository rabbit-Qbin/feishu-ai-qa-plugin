# AI 问答插件数据读取实现说明

## 数据读取方式

### 1. 飞书 SDK 提供的接口（本地接口，不需要外部 API）

插件使用 **飞书 Base JS SDK** 提供的接口来读取数据，这些接口是**本地接口**，不需要调用外部 API。

#### 核心接口：

```typescript
// 1. 获取表实例
const base = await workspace.getBitable(baseToken);
const table = await base.getTable(tableId);

// 2. 分页获取记录列表（核心数据读取接口）
const result = await table.getRecordListByPage({
  pageSize: 200,  // 每页记录数
  pageToken: undefined  // 分页令牌
});

// 3. 获取单个记录的字段值
const cell = await record.getCellByField(fieldId);
const value = await cell.getValue();
```

### 2. 数据读取流程（在 `executeQueryPlan` 函数中）

```typescript
// 第一步：分页获取所有记录
do {
  const result = await table.getRecordListByPage({
    pageSize: 200,
    pageToken
  });
  allRecords.push(...result.records);
  pageToken = result.hasMore ? result.pageToken : undefined;
} while (pageToken && allRecords.length < plan.limit * 2);

// 第二步：批量获取每个记录的字段值
for (let i = 0; i < allRecords.length; i += batchSize) {
  const batch = allRecords.slice(i, i + batchSize);
  const batchData = await Promise.all(
    batch.map(async (record) => {
      const cell = await record.getCellByField(fieldId);
      const value = await cell.getValue();
      return value;
    })
  );
}
```

### 3. 为什么不需要调用外部 API？

- **飞书 SDK 是本地 SDK**：运行在浏览器环境中，直接访问飞书多维表格的数据
- **数据在飞书服务器上**：SDK 通过飞书的 API 协议与服务器通信，但这是**飞书内部协议**，不是公开的 REST API
- **权限控制**：飞书 SDK 会自动处理用户权限、认证等，开发者无需关心

### 4. 与 AI API 的区别

| 项目 | 数据读取（飞书 SDK） | AI 问答（Moonshot API） |
|------|---------------------|------------------------|
| 接口类型 | 飞书 Base JS SDK | HTTP REST API |
| 调用位置 | 浏览器本地 | 外部服务器（api.moonshot.cn） |
| 是否需要 API Key | 否（SDK 自动处理） | 是（需要 Bearer Token） |
| 数据流向 | 飞书服务器 → 浏览器 | 浏览器 → Moonshot 服务器 |
| 用途 | 读取表格数据 | 生成 AI 回答 |

### 5. 完整的数据流

```
用户提问
  ↓
AI 意图识别（调用 Moonshot API）
  ├─ needData: false（闲聊/问功能/问概念）
  │   ↓
  │   AI 直接生成回答（调用 Moonshot API）
  │   ↓
  │   返回给用户
  │
  └─ needData: true（需要查询数据）
      ↓
      AI 生成查询计划（调用 Moonshot API）
      ↓
      执行查询计划（使用飞书 SDK 读取数据）
      ├─ table.getRecordListByPage()  ← 飞书 SDK（本地接口）
      └─ record.getCellByField()      ← 飞书 SDK（本地接口）
      ↓
      AI 生成回答（调用 Moonshot API，传入查询到的数据）
      ↓
      返回给用户
```

### 6. 代码位置

- **数据读取**：`src/main.ts` 中的 `executeQueryPlan()` 函数（第 759-860 行）
- **AI 调用**：`src/main.ts` 中的 `callMoonshotAPI()` 函数（第 934-1000 行）

### 总结

- ✅ **数据读取**：使用飞书 SDK 的本地接口，不需要外部 API
- ✅ **AI 问答**：调用 Moonshot (Kimi) 的外部 API，需要 API Key
- ✅ **两者结合**：先读取数据，再把数据传给 AI 进行分析

